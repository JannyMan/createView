<%@ Control Language="C#" AutoEventWireup="true" CodeBehind="ComsSignalrViewer.ascx.cs" Inherits="DXWebApp.UserControls.ComsSignalrViewer" %>

<script src="<%=ComsUrl %>Scripts/jquery-1.8.2.min.js" ></script>
<!--Reference the SignalR library. -->
<script src="<%=ComsUrl %>Scripts/jquery.signalR-1.2.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<!--<script src="../signalr/hubs"></script>-->
<script src="<%=ComsUrl %>signalr/hubs" type="text/javascript"></script>
<%--<link href="../App_Themes/" + "<%=DXWebApp.AppCode.Utils.CurrentTheme%>" + "/chatroom.css" rel="stylesheet" />--%>
<script type="text/javascript">
    function ComsViewApi() {
        //http://localhost/DXWebAppKB_branches_01/TestForm/TestComsPage.aspx
        this.SetComsParam = SetComsParam;
        function SetComsParam(group, name) {
            $.connection.hub.url = '<%=ComsUrl%>' + "signalr";
            // Proxy created on the fly
            var chat = $.connection.chatHub;
            var displayGroupname = group;
            var displayname = name;



            //显示消息
            chat.client.broadcastMessage = function (name, message, dtTime) {

            };


            //var chat = $.connection.pushHub;
            $.connection.hub.start().done(function () {


                //回车键发送信息
                document.onkeyup = function (e) {
                    var e = e || event;
                    if (e.keyCode == 13) {
                        //调用发送方法
                        sendMsg();
                    }
                };
                // 点击事件发送信息
                $('#sendmessage').click(function () {
                    sendMsg();
                    $('this').html('');
                });
                //封装发送函数
                function sendMsg() {

                }



                //var groupName = $('#displayGroupname').val();
                chat.server.loginRoom(displayGroupname, displayname);

            });

        };


        function ChatRoom() {
            this._init();
        }
        ChatRoom.prototype = {
            constructor:ChatRoom,
            _init:function () {

            },
            //显示时间
            showTime:function () {
            //进入房间时间提示
                var displayBoolean = false;
                //获取起始时间
                var date = new Date();
                var minute = date.getMinutes();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                var h = date.getHours();
                var time1 = y + '-' + m + '-' + d + '   ' + h + ':' + minute;


                chat.client.addUserIn = function (room, userName) {

                    //alert(room + ":" + userName);
                    $('#discussion').append('<li style="text-align: center;margin-top: 8px;color: #78777d;float: left;width: 100%;">' + time1 + '</li>');
                    //进入房间提示
                    var today = new Date();
                    var encodedtTime = $('<div />').text(today.toLocaleTimeString()).html();
                    if (userName != displayname) {
                        $('#discussion').append('<li style="color: #78777d;margin-top: 8px;float: left;width: 100%;">' + encodedtTime + " "
                            + ':&nbsp;&nbsp;用户' + displayname + '进入房间' + displayGroupname + '</li>');
                    }
                };
            },
            //发送信息
            sendMsg:function () {
                //去除前后空格
                var reg = /(^\s*)|(\s*$)/g;
                //var str = $('#message').val;
                var str = $('#message').val();
                var info = str.replace(reg, "");

                // Call the Send method on the hub.
                // chat.server.send($('#displayname').val(), $('#message').val());

                //判断内容是否为空
                if (info == '') {
                    return;
                } else {
                    var today = new Date();
                    chat.server.sendGroupMsg(group, name, info, today.toLocaleTimeString());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                    $("#rmWord").html('剩余输入字数：<b>66</b>');
                }
            },
            //显示消息
            showMsg:function (name, message, dtTime) {

                if (displayBoolean) {
                    //获取当前时间
                    var newDate = new Date();
                    var newMinute = newDate.getMinutes();
                    if (newMinute != minute) {
                        var year = newDate.getFullYear();
                        var month = newDate.getMonth() + 1;
                        var day = newDate.getDate();
                        var hh = newDate.getHours();
                        var newMinute = newDate.getMinutes();
                        var time = year + '-' + month + '-' + day + '   ' + hh + ':' + newMinute;
                        $('#discussion').append('<li style="text-align: center;margin-top: 8px;color: #78777d;float: left;width: 100%;">' + time + '</li>');
                        //更新起始时间
                        minute = newMinute;
                    }
                } else {
                    displayBoolean = true;
                }


                var scrollTops = $(window).scrollTop();
                var windowHeight = $(window).height();
                var documentHeight = $(document).height();
                var s = documentHeight - (windowHeight + scrollTops);

                if (name == displayname) {
                    $('#discussion').append('<li class = "liRight">' + '<span class="self myname">:&nbsp;&nbsp;' + name + '</span>' + '<span class = "myMsg">' + message + '</span>'
                        + '</li>');
                    //消息优化
                    var selfLiWidth = $('.container #discussion .liRight').width();
                    var selfNameWidth = $('.container #discussion .liRight .myname').width();

                    $('.container #discussion .liRight .myMsg').css({
                        maxWidth: selfLiWidth - selfNameWidth - 21
                    });
                } else {
                    $('#discussion').append('<li class = "liLeft"><span class="others othersName">' + name + '&nbsp;&nbsp;:</span>'
                        + '<span class="othersMsg">' + message + '</span>' + '</li>');
                    //消息优化
                    var selfLiWidth = $('.container #discussion .liRight').width();
                    var selfNameWidth = $('.container #discussion .liRight .myname').width();

                    $('.container #discussion .liRight .myMsg').css({
                        maxWidth: selfLiWidth - selfNameWidth - 21
                    });

                }

                setTimeout(function () {
                    //移动到最下面
                    var scrollTops = $(window).scrollTop();
                    var windowHeight = $(window).height();
                    var documentHeight = $(document).height();
                    var s = documentHeight - (windowHeight + scrollTops);
                    $('html,body').animate({ scrollTop: (s + scrollTops) + 'px' }, 'slow');
                }, 10);
            }
        }




    };

</script>

<div>
    <div class="container">
        <span id="roomName">

            </span>
        <div class="inputBox">
            <textarea id="message"></textarea>
            <div class="btn" title="下载">
                <span class="down" style="background: #cccacb;">
                    <img src="../App_Themes/" + "<%=DXWebApp.AppCode.Utils.CurrentTheme%>" + "/Images/chatroom/down_bai.png" />

                </span>
                <span class="send" id="sendmessage" title="发送">

                </span>
            </div>
            <!--显示剩余可以输入的字数-->
            <p id="rmWord">剩余输入字数：<b>66</b></p>
        </div>
        <input type="hidden" id="displayname"/>
        <input type="hidden" id="displayGroupname"/>
        <ul id="discussion"></ul>
        <div class="footer">
        </div>
    </div>

</div>

